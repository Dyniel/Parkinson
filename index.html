<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Parkinson Monitor — Serial</title>
<link rel="icon" href="data:,">
<style>
:root{--bg:#0b1020;--card:#11182b;--muted:#9bb0cf;--text:#e8eefc;--acc:#4da3ff;--acc2:#7cf;--ok:#1ec28b;--warn:#ffb020;--err:#ff5d5d;--br:14px}
*{box-sizing:border-box}
body{margin:0;background:linear-gradient(180deg,var(--bg),#070b17);color:var(--text);font:500 15px/1.5 ui-sans-serif,system-ui,Segoe UI,Arial}
.container{max-width:1100px;margin:28px auto;padding:0 16px}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.pill{display:flex;gap:8px;align-items:center;background:#0f1a33;color:var(--muted);padding:4px 10px;border-radius:999px}
.pill .dot{width:8px;height:8px;border-radius:50%;background:var(--warn)}
.card{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08);border-radius:14px}
.card .head{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.08)}
.card .body{padding:14px}
.controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
button,input,select{font:inherit}
button{background:linear-gradient(180deg,var(--acc),var(--acc2));color:#fff;border:none;border-radius:12px;padding:9px 12px;font-weight:700;cursor:pointer}
button.secondary{background:#0f1a33;border:1px solid rgba(255,255,255,.3);color:#fff}
button:disabled{opacity:.6;cursor:not-allowed}
input[type="number"],input[type="text"],select{background:#0f1a33;color:#fff;border:1px solid rgba(255,255,255,.25);border-radius:10px;padding:8px 10px}
canvas{width:100%;height:320px;display:block}
.kpi{display:flex;gap:12px;flex-wrap:wrap}
.kpi .item{background:#0f1a33;border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:10px 12px;min-width:160px}
.kpi .v{font-weight:800}
.terminal{font-family:ui-monospace,Menlo,Consolas,monospace;background:#0b1328;border:1px solid rgba(255,255,255,.12);border-radius:12px;min-height:180px;max-height:260px;overflow:auto;padding:10px;white-space:pre-wrap}
.terminal .rx{color:#9effa6}.terminal .tx{color:#9dbaff}
.inline{display:flex;gap:10px}.inline input{flex:1}
.row{display:grid;gap:14px}
@media(min-width:960px){.row{grid-template-columns:1.35fr 1fr}}
hr{border:none;border-top:1px solid rgba(255,255,255,.08);margin:12px 0}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div><b>Parkinson Monitor — Serial</b></div>
    <div class="pill"><div class="dot" id="dot"></div><span id="status">Rozłączony</span></div>
  </div>

  <div class="card">
    <div class="head">
      <div class="controls">
        <button id="btnSerial">Połącz Serial</button>
        <button id="btnDisconnect" class="secondary" disabled>Rozłącz</button>
        <label>baud <input id="baud" type="number" value="115200" min="1200" max="921600" step="1200"></label>
        <label>fs [Hz] <input id="fs" type="number" value="2" min="0.5" max="2000" step="0.1"></label>
        <label>Okno PSD [s] <input id="win" type="number" value="4" min="1" max="30" step="1"></label>
      </div>
      <div class="controls">
        <label><input type="checkbox" id="pause"> Pauza wykresów</label>
        <button id="btnClear" class="secondary">Czyść</button>
      </div>
    </div>

    <div class="body">
      <div class="kpi">
        <div class="item">Tremor peak 3–8 Hz<br><span class="v" id="peak">– Hz</span></div>
        <div class="item">Moc piku<br><span class="v" id="pwr">– dB</span></div>
        <div class="item">Próbek<br><span class="v" id="rows">0</span></div>
        <div class="item">Czas logu<br><span class="v" id="tlog">0.0 s</span></div>
        <div class="item">Bateria<br><span class="v" id="vbatt">– V</span></div>
      </div>

      <hr>
      <div class="row">
        <div class="card"><div class="head"><b>Sygnał w czasie</b></div><div class="body"><canvas id="chartTime"></canvas></div></div>
        <div class="card"><div class="head"><b>Widmo / PSD</b></div><div class="body"><canvas id="chartPsd"></canvas></div></div>
      </div>

      <hr>
      <div class="card">
        <div class="head"><b>Terminal i komendy</b></div>
        <div class="body">
          <div class="inline">
            <input id="cmd" type="text" placeholder="komenda… (Enter = +\\n)">
            <button id="btnSend"   class="secondary">Wyślij</button>
            <button id="btnSendLn" class="secondary">Wyślij + \\n</button>
            <button id="btnStart"  class="secondary">Start (t&lt;1&gt;, s&lt;1&gt;)</button>
          </div>
          <div class="terminal" id="term"></div>
        </div>
      </div>

      <hr>
      <div class="card">
        <div class="head"><b>Rejestracja do CSV</b></div>
        <div class="body">
          <div class="controls">
            <button id="btnStartLog">Start</button>
            <button id="btnStopLog" class="secondary" disabled>Stop</button>
            <button id="btnDownload" class="secondary" disabled>Pobierz CSV</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
/* ======== UI ======== */
const $=id=>document.getElementById(id);
const statusEl=$('status'), dotEl=$('dot'), termEl=$('term'), vbEl=$('vbatt');
const rowsEl=$('rows'), tlogEl=$('tlog'), peakEl=$('peak'), pwrEl=$('pwr');
const btnSerial=$('btnSerial'), btnDis=$('btnDisconnect'), btnClear=$('btnClear');
const btnSend=$('btnSend'), btnSendLn=$('btnSendLn'), btnStartBtn=$('btnStart'), cmdEl=$('cmd');
const fsEl=$('fs'), winEl=$('win'), pauseEl=$('pause'), baudEl=$('baud');
const btnStartLog=$('btnStartLog'), btnStopLog=$('btnStopLog'), btnDownload=$('btnDownload');

let serialPort=null, serialWriter=null;
function setStatus(txt,color){ statusEl.textContent=txt; dotEl.style.background=color; }
function termRX(s){ const d=document.createElement('div'); d.className='rx'; d.textContent='<< '+s; termEl.appendChild(d); termEl.scrollTop=termEl.scrollHeight; }
function termTX(s){ const d=document.createElement('div'); d.className='tx'; d.textContent='>> '+s; termEl.appendChild(d); termEl.scrollTop=termEl.scrollHeight; }

/* ======== DSP ======== */
let fs=+fsEl.value, winSec=+winEl.value;
fsEl.onchange=()=>{ fs=+fsEl.value; resetProcessing(); };
winEl.onchange=()=>{ winSec=+winEl.value; resetProcessing(); };

let ring=new Float32Array(1), head=0, filled=0, sampleCount=0;
function resetBuffers(){ const N=2**Math.ceil(Math.log2(Math.max(2,winSec)*Math.max(0.5,fs))); ring=new Float32Array(N); head=0; filled=0; }
function hpf(x){ const a=Math.exp(-2*Math.PI*0.5/fs); hpf.z=(hpf.z??x)+(1-a)*(x-(hpf.z??x)); return x-hpf.z; }
function resetProcessing(){ resetBuffers(); hpf.z=undefined; sampleCount=0; vbEl.textContent='– V'; }

/* ======== FFT (radix-2, in-place) ======== */
function fftRadix2(re, im){
  const n = re.length;
  // bit-reverse
  let j=0;
  for(let i=1;i<n-1;i++){
    let bit = n>>1;
    for(; j & bit; bit>>=1) j &= ~bit;
    j |= bit;
    if(i<j){ [re[i],re[j]]=[re[j],re[i]]; [im[i],im[j]]=[im[j],im[i]]; }
  }
  for(let len=2; len<=n; len<<=1){
    const ang = -2*Math.PI/len;
    const wlenRe = Math.cos(ang), wlenIm = Math.sin(ang);
    for(let i=0;i<n;i+=len){
      let wRe=1, wIm=0;
      for(let k=0;k<len/2;k++){
        const uRe = re[i+k], uIm = im[i+k];
        const vRe = re[i+k+len/2]*wRe - im[i+k+len/2]*wIm;
        const vIm = re[i+k+len/2]*wIm + im[i+k+len/2]*wRe;
        re[i+k] = uRe + vRe;
        im[i+k] = uIm + vIm;
        re[i+k+len/2] = uRe - vRe;
        im[i+k+len/2] = uIm - vIm;
        const tRe=wRe*wlenRe - wIm*wlenIm;
        wIm = wRe*wlenIm + wIm*wlenRe;
        wRe = tRe;
      }
    }
  }
}

/* ======== Wykresy ======== */
let timeChart, psdChart;
window.addEventListener('load', ()=>{
  timeChart=new Chart($('chartTime'),{
    type:'line',
    data:{datasets:[{label:'Sygnał',data:[],borderWidth:2,pointRadius:0,tension:0,borderColor:'#4da3ff'}]},
    options:{responsive:true,maintainAspectRatio:false,animation:false,parsing:false,
      plugins:{legend:{display:false}},
      scales:{x:{type:'linear',title:{display:true,text:'czas [s]'}},y:{title:{display:true,text:'Amplituda'}}}}
  });
  psdChart=new Chart($('chartPsd'),{
    type:'line',
    data:{datasets:[{label:'PSD',data:[],borderWidth:2,pointRadius:0,tension:0,borderColor:'#7cf'}]},
    options:{responsive:true,maintainAspectRatio:false,animation:false,parsing:false,
      plugins:{legend:{display:false}},
      scales:{x:{title:{display:true,text:'Hz'}},y:{title:{display:true,text:'dB'}}}}
  });
});

/* ======== CSV ======== */
let logging=false, csv=[], t0=null;
function csvHeader(){ return 't_sec,sample,vbat_V\n'; }
function startLog(){ csv=[csvHeader().trimEnd()]; logging=true; t0=performance.now(); btnStartLog.disabled=true; btnStopLog.disabled=false; btnDownload.disabled=true; }
function stopLog(){ logging=false; btnStartLog.disabled=false; btnStopLog.disabled=true; btnDownload.disabled=false; }
function logRow(y){ if(!logging) return; const t=((performance.now()-t0)/1000).toFixed(6); csv.push(`${t},${y},${(vbEl.textContent||'').replace(' V','')}`); rowsEl.textContent=csv.length-1; tlogEl.textContent=t+' s'; }

/* ======== PSD ======== */
function analyzePSD(){
  const N = ring.length;
  const re = new Float32Array(N);
  const im = new Float32Array(N);
  const win = new Float32Array(N);
  for(let n=0;n<N;n++) win[n]=0.5*(1-Math.cos(2*Math.PI*n/(N-1))); // Hanning

  const start=head;
  for(let n=0;n<N;n++){ const idx=(start+n)&(N-1); re[n]=ring[idx]*win[n]; im[n]=0; }

  fftRadix2(re,im);

  const mags=[], freqs=[];
  const norm = 1/(N*N);
  const N2 = Math.floor(N/2);
  for(let k=1;k<=N2;k++){
    const p=(re[k]*re[k]+im[k]*im[k])*norm;
    const hz=k*fs/N;
    freqs.push(hz);
    mags.push(10*Math.log10(p+1e-12));
  }
  // peak 3–8 Hz
  let peakHz=NaN, peakDb=-1e9;
  for(let i=0;i<mags.length;i++){ if(freqs[i]>=3 && freqs[i]<=8 && mags[i]>peakDb){ peakDb=mags[i]; peakHz=freqs[i]; } }
  peakEl.textContent=isFinite(peakHz)?peakHz.toFixed(2):'–';
  pwrEl.textContent=isFinite(peakDb)?peakDb.toFixed(1):'–';

  if(!pauseEl.checked){
    psdChart.data.datasets[0].data = mags.map((m,i)=>({x:freqs[i],y:m}));
    psdChart.update('none');
  }
}

/* ======== streaming ======== */
function pushSample(x){
  const y=hpf(x);
  sampleCount++;
  const tsec=sampleCount/fs;
  ring[head]=y; head=(head+1)&(ring.length-1); filled=Math.min(filled+1,ring.length);
  logRow(y);
  if(!pauseEl.checked){
    const ds=timeChart.data.datasets[0].data; ds.push({x:tsec,y}); if(ds.length>600) ds.splice(0,ds.length-600);
    timeChart.update('none');
  }
  if(filled===ring.length) analyzePSD();
}

/* ======== parser pakietów tekstowych ======== */
/* format: "1, 1, <ts> , <val>, stan baterii: <v>V end" */
let pktBuf='', lastTs=null, estFs=null;
function processTextChunk(s){
  termRX(s);
  pktBuf += s.replace(/\r/g,'\n');
  const parts = pktBuf.split(/end\s*/i);
  pktBuf = parts.pop() ?? '';
  for(const p of parts){
    const m = p.match(/(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)/);
    if(m){
      const ts = Number(m[3]);     // znacznik czasu z urządzenia (ms)
      const val = Number(m[4]);
      if(Number.isFinite(ts) && lastTs!=null){
        const dt = ts - lastTs;    // ms
        if(dt>0){
          const curFs = 1000/dt;
          estFs = estFs==null ? curFs : estFs*0.9 + curFs*0.1;
          fs = estFs; fsEl.value = Math.max(0.5, Math.round(fs*100)/100);
        }
      }
      lastTs = Number.isFinite(ts)? ts : lastTs;
      if(Number.isFinite(val)) pushSample(val);
    }
    const vb = p.match(/stan\s*baterii:\s*([\d.]+)/i);
    if(vb){ vbEl.textContent=(+vb[1]).toFixed(2)+' V'; }
  }
}

/* ======== Web Serial ======== */
async function connectSerial(){
  if(!('serial' in navigator)){ alert('Brak Web Serial w tej przeglądarce'); return; }
  try{
    serialPort = await navigator.serial.requestPort();
    await serialPort.open({ baudRate:+baudEl.value });
    setStatus('Połączony (Serial)','var(--ok)'); btnDis.disabled=false;

    const reader = serialPort.readable.getReader();
    (async function readLoop(){
      for(;;){
        const {value,done} = await reader.read();
        if(done) break;
        if(!(value instanceof Uint8Array)) continue;
        const s = new TextDecoder().decode(value);
        processTextChunk(s);
      }
    })();

    const enc = new TextEncoderStream();
    enc.readable.pipeTo(serialPort.writable).catch(()=>{});
    serialWriter = enc.writable.getWriter();
  }catch(e){
    alert('Błąd Serial: '+e);
  }
}
async function disconnectSerial(){
  try{
    if(serialWriter){ try{await serialWriter.close();}catch(_){} serialWriter=null; }
    if(serialPort){ try{await serialPort.close();}catch(_){} serialPort=null; }
  }finally{
    setStatus('Rozłączony','var(--warn)'); btnDis.disabled=true;
  }
}

/* ======== TX ======== */
async function sendRaw(s){
  if(serialWriter){ try{ await serialWriter.write(s); termTX(s.replace(/\n/g,'⏎')); }catch(e){ alert('Serial TX błąd: '+e); } }
  else alert('Brak kanału TX');
}

/* ======== UI events ======== */
btnSerial.onclick = connectSerial;
btnDisconnect.onclick = disconnectSerial;
btnClear.onclick=()=>{ timeChart.data.datasets[0].data.length=0; timeChart.update('none'); psdChart.data.datasets[0].data.length=0; psdChart.update('none'); termEl.textContent=''; rowsEl.textContent='0'; tlogEl.textContent='0.0 s'; resetProcessing(); };
btnSend.onclick = ()=>{ sendRaw(cmdEl.value);      cmdEl.value=''; };
btnSendLn.onclick= ()=>{ sendRaw(cmdEl.value+'\n'); cmdEl.value=''; };
cmdEl.addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); sendRaw(cmdEl.value+'\n'); cmdEl.value=''; } });
btnStart.onclick=()=>{ sendRaw('t<1>\n'); sendRaw('s<1>\n'); };
btnStartLog.onclick=()=>{ startLog(); };
btnStopLog.onclick =()=>{ stopLog();  };
btnDownload.onclick=()=>{ const blob=new Blob([csv.join('\n')+'\n'],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='parkinson_log.csv'; a.click(); URL.revokeObjectURL(a.href); };

/* ======== init ======== */
setStatus('Rozłączony','var(--warn)'); resetProcessing();
</script>
</body>
</html>
