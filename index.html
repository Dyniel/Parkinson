<!doctype html>
<html lang="pl">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Parkinson BLE Viz</title>
<button id="btn">Połącz BLE</button>
<label>fs [Hz] <input id="fs" type="number" value="200"></label>
<label>Okno PSD [s] <input id="win" type="number" value="8"></label>
<div>Szczyt 3–8 Hz: <span id="peak">–</span> Hz, moc: <span id="pwr">–</span> dB</div>
<canvas id="chartTime"></canvas>
<canvas id="chartPsd"></canvas>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fft.js@4.0.4/dist/fft.min.js"></script>
<script>
const UUID_SVC='6e400001-b5a3-f393-e0a9-e50e24dcca9e',UUID_RX='6e400003-b5a3-f393-e0a9-e50e24dcca9e';
let fs=+document.getElementById('fs').value,winSec=+document.getElementById('win').value;
document.getElementById('fs').onchange=e=>fs=+e.target.value;
document.getElementById('win').onchange=e=>{winSec=+e.target.value;resetBuffers();};
let buf=new Float32Array(1),head=0,filled=0; function resetBuffers(){const N=2**Math.ceil(Math.log2(winSec*fs));buf=new Float32Array(N);head=0;filled=0;} resetBuffers();
const timeChart=new Chart(document.getElementById('chartTime'),{type:'line',data:{labels:new Array(500).fill(''),datasets:[{data:new Array(500).fill(null)}]},options:{animation:false,parsing:false,plugins:{legend:{display:false}},scales:{x:{display:false},y:{title:{display:true,text:'Sygnał'}}}}});
const psdChart=new Chart(document.getElementById('chartPsd'),{type:'line',data:{labels:[],datasets:[{data:[]}]},options:{animation:false,parsing:false,plugins:{legend:{display:false}},scales:{x:{title:{display:true,text:'Hz'}},y:{title:{display:true,text:'dB'}}}}});
async function connectBLE(){const dev=await navigator.bluetooth.requestDevice({filters:[{services:[UUID_SVC]}]});const srv=await (await dev.gatt.connect()).getPrimaryService(UUID_SVC);const rx=await srv.getCharacteristic(UUID_RX);await rx.startNotifications();rx.addEventListener('characteristicvaluechanged',onChunk);}
function onChunk(e){const v=e.target.value;for(let i=0;i<v.byteLength;i+=2){pushSample(v.getInt16(i,true));}}
function pushSample(x){const a=Math.exp(-2*Math.PI*0.5/fs);pushSample.z=(pushSample.z??x)+(1-a)*(x-(pushSample.z??x));const y=x-pushSample.z;buf[head]=y;head=(head+1)&(buf.length-1);filled=Math.min(filled+1,buf.length);const ds=timeChart.data.datasets[0].data;ds.push(y);if(ds.length>500)ds.shift();timeChart.update('none');if(filled===buf.length)analyzePSD();}
function analyzePSD(){const N=buf.length,re=new Float32Array(N),im=new Float32Array(N),hann=new Float32Array(N);for(let n=0;n<N;n++)hann[n]=0.5*(1-Math.cos(2*Math.PI*n/(N-1)));const start=head;for(let n=0;n<N;n++){const idx=(start+n)&(N-1);re[n]=buf[idx]*hann[n];}const f=new FFT(N);f.transform(re,im,re,im);const mags=[],freqs=[],norm=1/(N*N),N2=Math.floor(N/2);for(let k=1;k<=N2;k++){const p=(re[k]*re[k]+im[k]*im[k])*norm;const hz=k*fs/N;freqs.push(hz);mags.push(10*Math.log10(p+1e-12));}let peakHz=NaN,peakDb=-1e9;for(let i=0;i<mags.length;i++){if(freqs[i]>=3&&freqs[i]<=8&&mags[i]>peakDb){peakDb=mags[i];peakHz=freqs[i];}}document.getElementById('peak').textContent=isFinite(peakHz)?peakHz.toFixed(2):'–';document.getElementById('pwr').textContent=isFinite(peakDb)?peakDb.toFixed(1):'–';psdChart.data.labels=freqs;psdChart.data.datasets[0].data=mags;psdChart.update('none');}
document.getElementById('btn').onclick=connectBLE;
</script>
</html>
